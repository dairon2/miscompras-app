generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(uuid())
  email                String             @unique
  password             String
  name                 String?
  role                 Role               @default(USER)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  areaId               String?
  lastLoginAt          DateTime?
  mustChangePassword   Boolean            @default(false)
  passwordResetExpires DateTime?
  passwordResetToken   String?
  refreshToken         String?
  refreshTokenExpires  DateTime?
  isActive             Boolean            @default(true)
  phone                String?
  position             String?
  budgetsApproved      Budget[]           @relation("BudgetApprovedBy")
  budgetsCreated       Budget[]           @relation("BudgetCreatedBy")
  managedBudgets       Budget[]           @relation("BudgetManager")
  adjustmentsRequested BudgetAdjustment[] @relation("AdjustmentRequestedBy")
  adjustmentsReviewed  BudgetAdjustment[] @relation("AdjustmentReviewedBy")
  budgetSubLeader      BudgetSubLeader[]
  requirementsCreated  Requirement[]      @relation("CreatedBy")
  requirementsOwned    Requirement[]      @relation("OwnedBy")
  groupsCreated        RequirementGroup[] @relation("GroupCreator")
  area                 Area?              @relation(fields: [areaId], references: [id])
}

model Project {
  id           String        @id @default(uuid())
  name         String
  code         String        @unique
  description  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  budgets      Budget[]
  requirements Requirement[]
}

model Area {
  id           String        @id @default(uuid())
  name         String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  budgets      Budget[]
  requirements Requirement[]
  users        User[]
}

model Supplier {
  id           String        @id @default(uuid())
  name         String
  taxId        String?       @unique
  contactEmail String?
  contactPhone String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  address      String?
  contactName  String?
  email        String?
  nit          String?       @unique
  phone        String?
  requirements Requirement[]
}

model Category {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String?
  budgets     Budget[]
}

model Budget {
  id                String             @id @default(uuid())
  amount            Decimal            @db.Decimal(15, 2)
  available         Decimal            @db.Decimal(15, 2)
  categoryId        String?
  projectId         String
  areaId            String
  managerId         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  approvedAt        DateTime?
  approvedById      String?
  code              String?            @unique
  createdById       String?
  description       String?
  documentUrl       String?
  status            BudgetStatus       @default(PENDING)
  title             String
  version           Int                @default(1)
  year              Int                @default(2025)
  expirationDate    DateTime?
  adjustmentSources AdjustmentSource[]
  approvedBy        User?              @relation("BudgetApprovedBy", fields: [approvedById], references: [id])
  area              Area               @relation(fields: [areaId], references: [id])
  category          Category?          @relation(fields: [categoryId], references: [id])
  createdBy         User?              @relation("BudgetCreatedBy", fields: [createdById], references: [id])
  manager           User?              @relation("BudgetManager", fields: [managerId], references: [id])
  project           Project            @relation(fields: [projectId], references: [id])
  adjustments       BudgetAdjustment[]
  subLeaders        BudgetSubLeader[]
  requirements      Requirement[]

  @@unique([projectId, areaId, categoryId, year])
}

model BudgetSubLeader {
  id        String   @id @default(uuid())
  budgetId  String
  userId    String
  createdAt DateTime @default(now())
  budget    Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([budgetId, userId])
}

model BudgetAdjustment {
  id              String             @id @default(uuid())
  code            String?            @unique
  type            AdjustmentType
  budgetId        String
  requestedAmount Decimal            @db.Decimal(15, 2)
  reason          String
  status          AdjustmentStatus   @default(PENDING)
  documentUrl     String?
  requestedById   String
  requestedAt     DateTime           @default(now())
  reviewedById    String?
  reviewedAt      DateTime?
  reviewComment   String?
  sources         AdjustmentSource[]
  budget          Budget             @relation(fields: [budgetId], references: [id])
  requestedBy     User               @relation("AdjustmentRequestedBy", fields: [requestedById], references: [id])
  reviewedBy      User?              @relation("AdjustmentReviewedBy", fields: [reviewedById], references: [id])
}

model AdjustmentSource {
  id           String           @id @default(uuid())
  adjustmentId String
  budgetId     String
  amount       Decimal          @db.Decimal(15, 2)
  adjustment   BudgetAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  budget       Budget           @relation(fields: [budgetId], references: [id])
}

model Requirement {
  id                     String              @id @default(uuid())
  title                  String
  description            String
  quantity               String?
  estimatedAmount        Decimal?            @db.Decimal(15, 2)
  actualAmount           Decimal?            @db.Decimal(15, 2)
  status                 Status              @default(PENDING_APPROVAL)
  procurementStatus      ProcurementStatus   @default(PENDIENTE)
  projectId              String
  areaId                 String
  supplierId             String?
  manualSupplierName     String?
  createdById            String
  currentOwnerId         String?
  budgetId               String?
  purchaseOrderNumber    String?
  invoiceNumber          String?
  deliveryDate           DateTime?
  receivedAtSatisfaction Boolean             @default(false)
  satisfactionComments   String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  hasMultiplePayments    Boolean             @default(false)
  isAsiento              Boolean             @default(false)
  reqCategory            RequirementCategory @default(COMPRA)
  totalAmount            Decimal?            @db.Decimal(15, 2)
  year                   Int                 @default(2025)
  groupId                Int?
  leaderApproval         Boolean?
  coordinatorApproval    Boolean?
  directorApproval       Boolean?
  leaderComment          String?
  coordinatorComment     String?
  directorComment        String?
  attachments            Attachment[]
  logs                   HistoryLog[]
  payments               Payment[]
  area                   Area                @relation(fields: [areaId], references: [id])
  budget                 Budget?             @relation(fields: [budgetId], references: [id])
  createdBy              User                @relation("CreatedBy", fields: [createdById], references: [id])
  currentOwner           User?               @relation("OwnedBy", fields: [currentOwnerId], references: [id])
  project                Project             @relation(fields: [projectId], references: [id])
  supplier               Supplier?           @relation(fields: [supplierId], references: [id])
  group                  RequirementGroup?   @relation(fields: [groupId], references: [id])
}

model RequirementGroup {
  id           Int           @id @default(autoincrement())
  creatorId    String
  creator      User          @relation("GroupCreator", fields: [creatorId], references: [id])
  pdfUrl       String?
  createdAt    DateTime      @default(now())
  requirements Requirement[]
}

model Attachment {
  id            String      @id @default(uuid())
  fileName      String
  fileUrl       String
  requirementId String
  createdAt     DateTime    @default(now())
  requirement   Requirement @relation(fields: [requirementId], references: [id])
}

model HistoryLog {
  id            String      @id @default(uuid())
  action        String
  details       String?
  requirementId String
  createdAt     DateTime    @default(now())
  requirement   Requirement @relation(fields: [requirementId], references: [id])
}

model Notification {
  id            String   @id @default(uuid())
  title         String
  message       String
  type          String   @default("INFO")
  isRead        Boolean  @default(false)
  userId        String
  requirementId String?
  createdAt     DateTime @default(now())
}

model Payment {
  id            String      @id @default(uuid())
  paymentNumber Int
  amount        Decimal     @db.Decimal(15, 2)
  invoiceNumber String?
  paymentDate   DateTime?
  observations  String?
  requirementId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
}

enum Role {
  USER
  LEADER
  DIRECTOR
  ADMIN
  COORDINATOR
  AUDITOR
  DEVELOPER
}

enum BudgetStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdjustmentType {
  INCREASE
  TRANSFER
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Status {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum ProcurementStatus {
  ANULADO
  ENTREGADO
  EN_TRAMITE
  PENDIENTE
  FINALIZADO
  POSTERGADO
}

model SystemConfig {
  id                    String   @id @default("main")
  activeYear            Int      @default(2025)
  appName               String   @default("MisCompras")
  isRegistrationEnabled Boolean  @default(true)
  maintenanceMode       Boolean  @default(false)
  updatedAt             DateTime @updatedAt
}

enum RequirementCategory {
  ANTICIPO
  COMPRA
  COMPRA_ONLINE
  CONTRATO
  ORDEN_COMPRA
  ORDEN_SERVICIO
  ORDEN_PRODUCCION
  SERVICIO
}
